<script>

const USERS = [
    { username: "melven", role: "god" },
    { username: "kevin", role: "superadmin" }
];

let currentUser = null;
let uploadedImage = null;
let editingEventId = null;

/* ================= VIEW ================= */

function showView(id) {
    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

/* ================= LOGIN ================= */

function login() {
    const name = document.getElementById("usernameInput").value.toLowerCase();
    const user = USERS.find(u => u.username === name);
    if (!user) return alert("Unbekannter Benutzer");

    currentUser = user;
    showView("mainView");
    initMainUI();
}

function logout() {
    location.reload();
}

/* ================= MAIN ================= */

function initMainUI() {
    if (currentUser.role === "god" || currentUser.role === "superadmin") {
        document.getElementById("addButton").classList.remove("hidden");
    }

    if (currentUser.role === "god") {
        document.getElementById("godMenuItem").classList.remove("hidden");
    }

    renderEvents();
}

/* ================= EVENTS ================= */

function renderEvents() {
    let events = JSON.parse(localStorage.getItem("mia_events")) || [];
    const today = new Date().toISOString().split("T")[0];

    events = events.filter(e => e.date >= today);
    events.sort((a,b)=>new Date(a.date)-new Date(b.date));
    events = events.slice(0,6);

    localStorage.setItem("mia_events", JSON.stringify(events));

    const container = document.getElementById("eventContainer");
    container.innerHTML = events.map((event, i) => `
        <div class="event-card ${i===0?'today':''}">
            <div class="event-bg" style="background-image:url('${event.image}')"></div>
            <div class="event-content">
                <img src="${event.image}" class="event-image">
                <h2>${event.title}</h2>
                <p>${event.date}</p>
                <p>${event.description}</p>
                ${
                    currentUser.role === "god" || currentUser.role === "superadmin"
                    ? `<div class="event-actions">
                           <button onclick="editEvent(${event.id})">Bearbeiten</button>
                           <button onclick="deleteEvent(${event.id})">LÃ¶schen</button>
                       </div>`
                    : ""
                }
            </div>
        </div>
    `).join("");
}

function saveEvent() {
    let events = JSON.parse(localStorage.getItem("mia_events")) || [];

    const newEvent = {
        id: editingEventId || Date.now(),
        title: eventTitle.value,
        date: eventDate.value,
        description: eventDesc.value,
        image: uploadedImage || ""
    };

    if (!newEvent.title || !newEvent.date) return alert("Titel & Datum Pflicht");

    if (editingEventId) {
        events = events.map(e => e.id === editingEventId ? newEvent : e);
    } else {
        events.push(newEvent);
    }

    localStorage.setItem("mia_events", JSON.stringify(events));
    closeAll();
    renderEvents();
}

function editEvent(id) {
    const events = JSON.parse(localStorage.getItem("mia_events")) || [];
    const event = events.find(e => e.id === id);

    editingEventId = id;
    eventTitle.value = event.title;
    eventDate.value = event.date;
    eventDesc.value = event.description;
    uploadedImage = event.image;
    imagePreview.src = event.image;
    imagePreview.style.display="block";

    openEventModal();
}

function deleteEvent(id) {
    if (!confirm("Event lÃ¶schen?")) return;
    let events = JSON.parse(localStorage.getItem("mia_events")) || [];
    events = events.filter(e => e.id !== id);
    localStorage.setItem("mia_events", JSON.stringify(events));
    renderEvents();
}

/* ================= MODALS ================= */

function openRegister() {
    document.getElementById("registerModal").classList.remove("hidden");
}

function openEventModal() {
    editingEventId = null;
    document.getElementById("eventModal").classList.remove("hidden");
}

function openGodGate() {
    document.getElementById("godModal").classList.remove("hidden");
}

function closeAll(){
    document.querySelectorAll(".modal").forEach(m=>m.classList.add("hidden"));
    document.getElementById("sideMenu").classList.remove("active");
}

/* ================= OUTSIDE CLICK HANDLING ================= */

document.addEventListener("click", function (e) {

    /* Modal schlieÃŸen wenn auÃŸerhalb modal-box */
    document.querySelectorAll(".modal").forEach(modal => {
        const box = modal.querySelector(".modal-box");
        if (!modal.classList.contains("hidden")) {
            if (!box.contains(e.target)) {
                modal.classList.add("hidden");
            }
        }
    });

    /* MenÃ¼ schlieÃŸen wenn auÃŸerhalb */
    const menu = document.getElementById("sideMenu");
    const hamburger = document.querySelector(".hamburger");

    if (menu.classList.contains("active") &&
        !menu.contains(e.target) &&
        !hamburger.contains(e.target)) {
        menu.classList.remove("active");
    }
});

/* ================= MENU ================= */

function toggleMenu() {
    document.getElementById("sideMenu").classList.toggle("active");
}

/* ================= GOD ================= */

function checkGodPin() {
    if (godPinInput.value === "1337") {
        alert("GOD Dashboard coming soon ðŸ˜Ž");
    } else {
        alert("Falscher PIN");
    }
}

/* ================= IMAGE UPLOAD ================= */

uploadArea.onclick = ()=> imageInput.click();

imageInput.onchange = e=>{
    const reader = new FileReader();
    reader.onload = ev=>{
        uploadedImage = ev.target.result;
        imagePreview.src = uploadedImage;
        imagePreview.style.display="block";
    };
    reader.readAsDataURL(e.target.files[0]);
};

</script>
